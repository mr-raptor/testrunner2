<html>
<head>
    <% include ../partials/head %>
	<script>
		function getFixture($fixture) {
			var fixture = {};
			fixture.name = $fixture.attr("name");
			fixture.tests = [];
			$.each($fixture.find("div.test"), function(i,v) {
				fixture.tests.push(getTest($(v)));
			});
			return fixture;
		}
		
		function getTest($test) {
			var test = {};
			test.name = $test.attr("name");
			test.assembly = $test.attr("assembly");
			test.active = $test.find("input.test").prop("checked");
			test.browsers = [];
			$.each($test.find("input.browser:checked"), function(i,v) {
				test.browsers.push($(v).attr("browser"));
			});
			return test;
		}
	
		$(document).ready(function() {
			$('#run_tests').click(function() {
				var data = {};
				data.fixtures = [];
				var $fixtures = $('.fixture');
				$.each($fixtures, function(i,v) {
					data.fixtures.push(getFixture($(v)));
				});
				
				$.ajax({
					method: "POST",
					url: "/run",
					contentType: "application/json",
					data: JSON.stringify(data)
				}).done(function(msg) {
					$('#message').html(msg);
				});
			});
			
			$('.all_tests').change(function() {
				var $fixture = $(this).closest('.fixture');
				var checked = this.checked;
				$.each($fixture.find('input.test'), function(i,v) {
					$(v).prop('checked', checked);
				});
			});
			
			$.each($('.all_tests'), function(i,v) {
				var tests = $(this).closest('.fixture').find('input.test');
				var all_tests_checked = true;
				for(i=0; i<tests.length; i++) {			
					all_tests_checked = all_tests_checked && $(tests[i]).prop('checked');
				}
				$(v).prop('checked', all_tests_checked);
			});
		});
	</script>
</head>
<body>
    <header>
        <% include ../partials/header %>
		<h1><i>Test Runner</i></h1>
    </header>
	<div id="content">
		<div class="browsers">
		<% browsers.forEach(browser => { %>
			<span class="browser"><%=browser%></span>
		<% }); %>
		</div>
		<% fixtures.forEach(fixture => { %>
		<div class="fixture" name="<%=fixture.name%>" >
			<h4>
				<input class="all_tests" type="checkbox" />
				<%= fixture.name %>
				<div class="browsers">
				<% browsers.forEach(browser => { %>
					<input class="browser" type="checkbox" />
				<% }); %>
				</div>				
			</h4>

			<div>	
				<ul>		
				<% fixture.tests.forEach(test => { %>
					<li>
						<div class="test" name="<%= test.name %>" assembly="<%=test.assembly%>"> <!-- need to refactor this -->
						<input class="test" type="checkbox" <%= test.active ? "checked" : "" %> />
						<%= test.name %>
						<div class="browsers">
						<% browsers.forEach(browser => { %>
							<input class="browser" type="checkbox" browser="<%=browser%>" <%= (test.browsers.indexOf(browser) !== -1) ? "checked" : "" %> />
						<% }); %>
						</div>
						</div>
					</li>
				<% }); %>
				</ul>
			</div>
		</div>
		<% }); %>
	</div>
    <footer>
		<div><a id="run_tests" href="#" class="button-0">Run!</a></div>
		<span id="message"></span>		
        <% include ../partials/footer %>
    </footer>
</body>
</html>